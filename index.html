<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ZenDocs | Pro Collab</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        bg: 'var(--bg-color)', surface: 'var(--surface-color)', sidebar: '#1e1e1e',  
                        border: 'var(--border-color)', text: 'var(--text-color)', muted: '#9ca3af',
                        accent: '#1a73e8', danger: '#d93025', gold: '#fbbc04'
                    },
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    animation: { 'fade-in-up': 'fadeInUp 0.4s ease-out forwards', 'pulse-fast': 'pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite' },
                    keyframes: { fadeInUp: { '0%': { opacity: '0', transform: 'translateY(15px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } } }
                }
            }
        }
    </script>
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <style>
        :root { --bg-color: #f0f2f5; --surface-color: #ffffff; --text-color: #1f2937; --border-color: #e5e7eb; --paper-bg: #ffffff; --paper-text: #000000; --toolbar-bg: #edf2fa; --toolbar-border: #e0e0e0; }
        html.dark { --bg-color: #121212; --surface-color: #1e1e1e; --text-color: #e5e7eb; --border-color: #374151; --paper-bg: #1e1e1e; --paper-text: #e0e0e0; --toolbar-bg: #2d2d2d; --toolbar-border: #404040; }
        body, div, button, input, select { transition: background-color 0.2s ease, color 0.2s ease; }
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #dadce0; border-radius: 4px; }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #1a73e8; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* EDITOR & LAYOUT */
        #editor-wrapper { background-color: var(--bg-color); padding: 40px 0; overflow-y: auto; flex: 1; display: flex; justify-content: center; align-items: flex-start; position: relative; }
        #paper-container { width: 794px; min-height: 1123px; background: var(--paper-bg); color: var(--paper-text); box-shadow: 0 1px 3px 0 rgba(0,0,0,.3); margin-bottom: 40px; display: flex; flex-direction: column; position: relative; }
        html.dark #paper-container { box-shadow: 0 4px 20px rgba(0,0,0,0.5); border: 1px solid #333; }
        .ql-container { font-size: 11pt; font-family: 'Times New Roman', serif; height: auto !important; }
        .ql-editor { padding: 96px; min-height: 1123px; height: auto !important; overflow-y: visible !important; }
        .ql-toolbar { border: none !important; background: var(--toolbar-bg); border-bottom: 1px solid var(--toolbar-border) !important; padding: 8px 16px !important; border-radius: 24px; margin: 8px 16px; }
        
        /* COLLABORATION CURSORS */
        .cursor-flag { position: absolute; font-size: 10px; color: white; padding: 2px 6px; border-radius: 4px; white-space: nowrap; pointer-events: none; z-index: 50; top: -20px; left: 0; box-shadow: 0 2px 4px rgba(0,0,0,0.2); transition: top 0.1s, left 0.1s; }
        .cursor-caret { position: absolute; width: 2px; height: 18px; z-index: 49; pointer-events: none; transition: top 0.1s, left 0.1s; }
        /* When someone else is editing a line */
        .locked-line-bg { background-color: rgba(255, 0, 0, 0.05); border-left: 2px solid rgba(255,0,0,0.4); }

        /* MOBILE */
        @media (max-width: 850px) {
            #editor-wrapper { padding: 0; }
            #paper-container { box-shadow: none; width: 100%; min-height: 100vh; margin: 0; }
            .ql-editor { padding: 20px 20px 80px 20px; }
            .ql-toolbar { margin: 0 !important; width: 100vw !important; border-radius: 0 !important; overflow-x: auto !important; display: flex !important; flex-flow: row nowrap !important; }
        }
        .sidebar-transition { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .sidebar-closed { transform: translateX(-100%); }
        .sidebar-open { transform: translateX(0); }
    </style>
</head>
<body class="h-screen w-screen overflow-hidden flex flex-col font-sans text-text bg-bg transition-colors duration-300">

    <div id="preview-banner" class="hidden bg-accent text-white px-4 py-2 text-sm flex justify-between items-center z-[70] shadow-md">
        <span class="truncate pr-2 flex items-center gap-2"><span class="animate-pulse">üü¢</span> <span id="access-status-text">Live View (Read Only)</span></span>
        <button id="request-access-btn" onclick="requestEditAccess()" class="bg-white text-accent px-3 py-1 rounded font-bold text-xs hover:bg-gray-100 shadow hidden">Request Edit Access</button>
    </div>

    <div id="loading-screen" class="absolute inset-0 z-[100] bg-bg flex items-center justify-center">
        <div class="flex flex-col items-center"><div class="loader mb-3"></div><div class="text-sm text-gray-500 font-medium animate-pulse">Syncing ZenDocs...</div></div>
    </div>

    <div id="app" class="flex-1 flex relative overflow-hidden">
        
        <div id="auth-screen" class="absolute inset-0 z-[80] bg-[#1e1e1e] flex items-center justify-center p-4 hidden">
            <div class="w-full max-w-sm bg-[#2d2d2d] p-8 rounded-xl shadow-2xl border border-gray-700 opacity-0 transform transition-all duration-500" id="auth-box">
                <h1 class="text-3xl font-light text-white text-center mb-1">Zen<span class="text-accent font-bold">Docs</span></h1>
                <form id="auth-form" class="space-y-4 mt-8">
                    <input type="email" id="email" class="w-full bg-[#1e1e1e] border border-gray-600 rounded-lg p-3 text-white focus:border-accent outline-none" placeholder="Email Address" required>
                    <input type="password" id="password" class="w-full bg-[#1e1e1e] border border-gray-600 rounded-lg p-3 text-white focus:border-accent outline-none" placeholder="Password" required>
                    <button type="submit" class="w-full bg-accent text-white font-bold py-3 rounded-lg hover:bg-blue-600 transition shadow-lg">Sign In</button>
                    <div class="flex justify-between items-center text-sm mt-4 pt-2 border-t border-gray-700">
                        <button type="button" id="signup-btn" class="text-gray-400 hover:text-white">Create Account</button>
                    </div>
                    <p id="auth-error" class="text-danger text-xs text-center min-h-[1.5em] mt-2"></p>
                </form>
            </div>
        </div>

        <div id="share-modal" class="absolute inset-0 z-[90] bg-black/70 hidden flex items-center justify-center p-4 backdrop-blur-sm">
            <div class="bg-surface rounded-xl p-6 max-w-md w-full shadow-2xl animate-fade-in-up border border-border">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-lg text-text">Share Document</h3>
                    <button onclick="closeShareModal()" class="text-gray-500 hover:text-text">‚úï</button>
                </div>
                
                <div class="mb-6 space-y-3">
                    <div class="flex items-center justify-between bg-bg p-3 rounded-lg">
                        <div>
                            <div class="text-sm font-semibold text-text">General Access</div>
                            <div class="text-[10px] text-muted">Control link behavior</div>
                        </div>
                        <select id="share-permission-select" onchange="updateSharePermissions()" class="bg-surface border border-border text-xs rounded px-2 py-1 outline-none text-text">
                            <option value="view">Viewer (Read Only)</option>
                            <option value="edit">Editor (Open Edit)</option>
                        </select>
                    </div>
                    
                    <div id="pending-requests-container" class="hidden">
                        <div class="text-xs font-bold text-muted uppercase tracking-wider mb-2">Access Requests</div>
                        <div id="requests-list" class="space-y-2 max-h-32 overflow-y-auto"></div>
                    </div>
                </div>

                <div class="flex gap-2">
                    <input type="text" id="share-link-input" class="flex-1 text-xs bg-bg border border-border rounded px-3 text-muted" readonly>
                    <button onclick="copyShareLink()" class="bg-accent text-white px-4 py-2 rounded text-xs font-bold hover:bg-blue-600 transition">Copy Link</button>
                </div>
            </div>
        </div>

        <div id="info-modal" class="absolute inset-0 z-[90] bg-black/70 hidden flex items-center justify-center p-4 backdrop-blur-sm">
            <div class="bg-surface rounded-xl p-6 max-w-md w-full shadow-2xl animate-fade-in-up h-[60vh] flex flex-col">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-lg text-text">Collaboration History</h3>
                    <button onclick="document.getElementById('info-modal').classList.add('hidden')" class="text-gray-500">‚úï</button>
                </div>
                <div id="history-list" class="flex-1 overflow-y-auto space-y-2 pr-2 custom-scrollbar"></div>
            </div>
        </div>

        <div id="dashboard-screen" class="hidden flex-1 flex w-full h-full relative opacity-0">
            <div id="mobile-overlay" class="md:hidden absolute inset-0 bg-black/50 z-[60] hidden backdrop-blur-sm" onclick="toggleSidebar()"></div>

            <aside id="sidebar" class="w-72 bg-sidebar text-gray-300 flex flex-col absolute md:relative z-[65] h-full sidebar-transition sidebar-closed md:transform-none border-r border-gray-800 shadow-xl">
                <div class="p-4 border-b border-gray-700 flex justify-between items-center h-16 bg-[#252525]">
                    <span class="font-bold text-white tracking-wide pl-1 text-lg">ZenDocs</span>
                    <button onclick="createNewDoc()" class="bg-white text-accent w-8 h-8 rounded-full flex items-center justify-center hover:bg-gray-200 transition text-2xl pb-1">+</button>
                </div>
                <div class="flex-1 overflow-y-auto p-3" id="doc-list"></div>
                <div class="p-3 bg-[#181818] border-t border-gray-800 text-xs text-center">
                    <span id="user-email" class="block mb-2 text-gray-500"></span>
                    <button onclick="auth.signOut();window.location.reload()" class="text-red-400 hover:text-red-300">Sign Out</button>
                </div>
            </aside>

            <main class="flex-1 flex flex-col h-full relative w-full bg-bg transition-colors duration-300">
                <div class="h-16 bg-surface border-b border-border flex items-center justify-between px-3 md:px-4 z-10 shadow-sm flex-shrink-0">
                    <div class="flex items-center gap-2 flex-1 min-w-0">
                        <button class="md:hidden text-muted p-2" onclick="toggleSidebar()">‚ò∞</button>
                        <div class="flex flex-col w-full min-w-0">
                            <input type="text" id="doc-title" onfocus="this.select()" class="bg-transparent text-lg font-semibold text-text outline-none w-full placeholder-gray-400 truncate" placeholder="Untitled" disabled>
                            <span id="save-status" class="text-[10px] text-muted font-medium h-3 truncate"></span>
                        </div>
                    </div>

                    <div class="flex items-center gap-2 pl-2">
                        <button id="info-btn" onclick="openInfoModal()" class="hidden p-2 rounded-full text-muted hover:bg-gray-100 hover:text-accent relative">
                            ‚ÑπÔ∏è <span id="request-badge" class="absolute top-0 right-0 w-2.5 h-2.5 bg-danger rounded-full hidden"></span>
                        </button>
                        
                        <button id="share-btn" onclick="openShareModal()" class="p-2 text-xs bg-blue-100 dark:bg-blue-900 text-accent rounded-full md:rounded hover:bg-blue-200 transition flex items-center gap-1" disabled>
                            <span>üîó</span> <span class="hidden md:inline">Share</span>
                        </button>

                        <button onclick="toggleTheme()" class="p-2 rounded-full text-muted hover:bg-gray-100 hover:text-accent">üåó</button>
                    </div>
                </div>

                <div id="editor-wrapper" class="opacity-50 pointer-events-none transition-opacity duration-500" onclick="focusEditor()">
                    <div id="cursors-layer" class="absolute inset-0 pointer-events-none z-[40] w-[794px] mx-auto hidden md:block"></div>
                    
                    <div id="paper-container">
                        <div id="editor-container"></div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

    <script>
        // --- FIREBASE CONFIG ---
        const firebaseConfig = {
          apiKey: "AIzaSyCFmwO9aa5RZgOwQ5b3tN8NPha_1UfrCjA",
          authDomain: "notes-b4daa.firebaseapp.com",
          projectId: "notes-b4daa",
          storageBucket: "notes-b4daa.firebasestorage.app",
          messagingSenderId: "372433592521",
          appId: "1:372433592521:web:348b2558084299be1a6d18"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- STATE & UTILS ---
        const generateColor = () => '#' + Math.floor(Math.random()*16777215).toString(16);
        const getSessionId = () => { let id = localStorage.getItem('z_sess_id'); if(!id) { id = Math.random().toString(36).substr(2,9); localStorage.setItem('z_sess_id', id); } return id; };
        
        let state = {
            user: null, docId: null, shareId: null, docs: [],
            isGuest: false, permission: 'view', // 'view' or 'edit'
            myColor: generateColor(),
            sessionId: getSessionId(),
            unsubDoc: null, unsubPresence: null, unsubRequests: null
        };

        const els = {
            app: document.getElementById('app'),
            authScreen: document.getElementById('auth-screen'),
            authBox: document.getElementById('auth-box'),
            dashboard: document.getElementById('dashboard-screen'),
            loading: document.getElementById('loading-screen'),
            title: document.getElementById('doc-title'),
            status: document.getElementById('save-status'),
            editorWrapper: document.getElementById('editor-wrapper'),
            cursorsLayer: document.getElementById('cursors-layer'),
            shareModal: document.getElementById('share-modal'),
            shareSelect: document.getElementById('share-permission-select'),
            requestBtn: document.getElementById('request-access-btn'),
            banner: document.getElementById('preview-banner'),
            accessText: document.getElementById('access-status-text'),
            requestsList: document.getElementById('requests-list'),
            requestsContainer: document.getElementById('pending-requests-container'),
            requestBadge: document.getElementById('request-badge'),
            infoBtn: document.getElementById('info-btn'),
            infoModal: document.getElementById('info-modal'),
            historyList: document.getElementById('history-list')
        };

        // --- QUILL INIT ---
        var quill = new Quill('#editor-container', {
            theme: 'snow', placeholder: 'Start writing...',
            modules: { toolbar: [[{'header':[1,2,false]}], ['bold','italic','underline', {'color':[]}, {'background':[]}], [{'list':'ordered'},{'list':'bullet'}], ['clean']] }
        });

        // --- AUTH & ROUTING ---
        auth.onAuthStateChanged(u => {
            state.user = u;
            const urlParams = new URLSearchParams(window.location.search);
            const urlShareId = urlParams.get('shareId');

            if (u) {
                // Logged in owner
                els.authScreen.classList.add('hidden');
                els.dashboard.classList.remove('hidden'); els.dashboard.classList.add('animate-fade-in-up');
                document.getElementById('user-email').textContent = u.email;
                
                if (urlShareId) {
                    // Logged in user visiting a link (Import Logic)
                    importSharedDoc(urlShareId);
                } else {
                    initOwnerData();
                }
            } else {
                // Guest
                if (urlShareId) {
                    loadGuestView(urlShareId);
                } else {
                    els.loading.classList.add('hidden');
                    els.authScreen.classList.remove('hidden'); els.authBox.classList.remove('opacity-0');
                }
            }
        });

        // --- OWNER LOGIC ---
        function initOwnerData() {
            els.loading.classList.add('hidden');
            document.getElementById('share-btn').disabled = false;
            
            db.collection('users').doc(state.user.uid).collection('docs').orderBy('updatedAt', 'desc').onSnapshot(snap => {
                state.docs = snap.docs.map(d => ({id: d.id, ...d.data()}));
                renderSidebar();
                if(!state.docId && state.docs.length > 0) openDoc(state.docs[0]);
                else if(state.docs.length === 0) createNewDoc();
            });
        }

        // --- GUEST/SHARED LOGIC ---
        async function loadGuestView(sid) {
            state.isGuest = true;
            state.shareId = sid;
            els.loading.classList.remove('hidden');
            
            // Listen to Shared Document
            state.unsubDoc = db.collection('shared_docs').doc(sid).onSnapshot(doc => {
                if(!doc.exists) return alert("Note deleted");
                const data = doc.data();
                
                els.loading.classList.add('hidden');
                els.authScreen.classList.add('hidden');
                els.dashboard.classList.remove('hidden'); els.dashboard.classList.add('animate-fade-in-up');
                document.getElementById('sidebar').classList.add('hidden');
                els.banner.classList.remove('hidden');

                // SYNC CONTENT
                syncContent(data.t, data.c);

                // ACCESS CONTROL
                // If global access is 'edit', everyone is an editor
                if (data.access === 'edit') {
                    setAccessMode('edit');
                } else {
                    // Default to view
                    setAccessMode('view');
                }

                // Initialize Presence
                initPresence(sid);
                
            }, err => console.error(err));
        }

        function setAccessMode(mode) {
            state.permission = mode;
            if(mode === 'edit') {
                quill.enable();
                els.editorWrapper.classList.remove('opacity-50', 'pointer-events-none');
                els.title.disabled = false;
                els.accessText.innerHTML = "üü¢ Live Collaboration (Editor)";
                els.requestBtn.classList.add('hidden');
            } else {
                quill.disable();
                els.editorWrapper.classList.remove('opacity-50'); // Keep opacity normal for reading
                els.editorWrapper.style.pointerEvents = 'auto'; // Allow scrolling
                document.querySelector('.ql-editor').contentEditable = false; // Disable typing
                els.title.disabled = true;
                els.accessText.innerHTML = "üëÅÔ∏è View Only";
                els.requestBtn.classList.remove('hidden');
            }
        }

        // --- CORE SYNC ---
        let isLocalChange = false;
        
        function syncContent(title, content) {
            if(isLocalChange) return;
            els.title.value = title;
            const currentDelta = JSON.stringify(quill.getContents());
            const incomingDelta = JSON.stringify(content);
            if (currentDelta !== incomingDelta) {
                const range = quill.getSelection();
                quill.setContents(content, 'silent');
                if(range) quill.setSelection(range);
            }
        }

        quill.on('text-change', (delta, old, source) => {
            if (source === 'user') {
                isLocalChange = true;
                
                // 1. Basic Debounced Save
                if (state.saveTimer) clearTimeout(state.saveTimer);
                state.saveTimer = setTimeout(() => saveContent(), 500);

                // 2. Log History (Debounced longer)
                if (state.historyTimer) clearTimeout(state.historyTimer);
                state.historyTimer = setTimeout(() => logHistory(), 2000);

                // 3. Locking Check (Visual)
                // We check if we are editing a line someone else is on.
                // Simple logic: If we type, we are "owning" this spot.
            }
        });
        
        // --- DATA SAVING ---
        async function saveContent() {
            els.status.textContent = "Saving...";
            const data = {
                t: els.title.value,
                c: quill.getContents(),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            try {
                if (state.isGuest) {
                    if (state.permission !== 'edit') return;
                    await db.collection('shared_docs').doc(state.shareId).update(data);
                } else {
                    await db.collection('users').doc(state.user.uid).collection('docs').doc(state.docId).update({
                        title: data.t, content: data.c, updatedAt: data.updatedAt
                    });
                    // Also update share copy if it exists
                    if(state.shareId) {
                         await db.collection('shared_docs').doc(state.shareId).update(data);
                    }
                }
                els.status.textContent = "Saved";
                isLocalChange = false;
            } catch(e) { console.error(e); els.status.textContent = "Error"; }
        }

        // --- PRESENCE & CURSORS (THE COOL PART) ---
        function initPresence(sid) {
            if(state.unsubPresence) state.unsubPresence();
            
            // 1. Send my heartbeat
            const presDoc = db.collection('shared_docs').doc(sid).collection('presence').doc(state.sessionId);
            
            // Update my position on selection change
            quill.on('selection-change', (range) => {
                if(range) {
                    const bounds = quill.getBounds(range.index);
                    presDoc.set({
                        u: state.user ? state.user.email : 'Guest',
                        c: state.myColor,
                        r: range.index, // Index
                        t: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    // Simple "Locking" Logic: Reset background colors
                    quill.formatText(0, quill.getLength(), 'background', false, 'api'); 
                }
            });

            // 2. Listen to others
            state.unsubPresence = db.collection('shared_docs').doc(sid).collection('presence').onSnapshot(snap => {
                els.cursorsLayer.innerHTML = ''; // Clear old cursors
                
                snap.forEach(doc => {
                    if(doc.id === state.sessionId) return; // Skip me
                    const p = doc.data();
                    if(!p.r) return;

                    // Calculate position
                    // We need a try-catch because if content is out of sync, getBounds fails
                    try {
                        const bounds = quill.getBounds(p.r);
                        if(bounds) {
                            // Draw Cursor
                            const flag = document.createElement('div');
                            flag.className = 'cursor-flag';
                            flag.textContent = p.u.split('@')[0];
                            flag.style.backgroundColor = p.c;
                            flag.style.top = (bounds.top - 20) + 'px';
                            flag.style.left = bounds.left + 'px';

                            const caret = document.createElement('div');
                            caret.className = 'cursor-caret';
                            caret.style.backgroundColor = p.c;
                            caret.style.top = bounds.top + 'px';
                            caret.style.left = bounds.left + 'px';
                            caret.style.height = bounds.height + 'px';

                            els.cursorsLayer.appendChild(flag);
                            els.cursorsLayer.appendChild(caret);

                            // LOCKING: Highlight the line they are on
                            // Note: This is visual only ("Soft Lock")
                            const line = quill.getLine(p.r); 
                            if(line && line[0]) {
                                // We can add a class to the DOM node directly
                                // line[0].domNode.classList.add('locked-line-bg'); // Tricky to clear
                            }
                        }
                    } catch(e) {}
                });
            });
        }

        // --- HISTORY LOGGER ---
        async function logHistory() {
            if(!state.shareId) return;
            const user = state.user ? state.user.email : (state.isGuest ? "Guest " + state.sessionId.substr(0,4) : "Anonymous");
            // Just a simple log
            await db.collection('shared_docs').doc(state.shareId).collection('history').add({
                msg: `${user} edited the document`,
                ts: firebase.firestore.FieldValue.serverTimestamp()
            });
        }

        // --- ACCESS REQUEST LOGIC ---
        window.requestEditAccess = async () => {
            if(!state.shareId) return;
            const name = prompt("Enter your name to request access:");
            if(!name) return;
            
            await db.collection('shared_docs').doc(state.shareId).collection('requests').add({
                name: name,
                sid: state.sessionId,
                ts: firebase.firestore.FieldValue.serverTimestamp()
            });
            alert("Request sent! The owner receives it instantly.");
        };

        // --- SHARING & MODALS ---
        window.openShareModal = () => {
            if(!state.shareId) createShareLink(); // Generate if new
            else {
                // Fetch current permission
                db.collection('shared_docs').doc(state.shareId).get().then(d => {
                    els.shareSelect.value = d.data().access || 'view';
                    updateShareLinkUI();
                    els.shareModal.classList.remove('hidden');
                    loadRequests(); // Load requests if owner
                });
            }
        };
        
        window.closeShareModal = () => els.shareModal.classList.add('hidden');

        async function createShareLink() {
            // Create shared doc entry
            const activeDoc = state.docs.find(d => d.id === state.docId);
            const docRef = await db.collection('shared_docs').add({
                t: activeDoc.title,
                c: activeDoc.content,
                ownerId: state.user.uid,
                email: state.user.email,
                access: 'view', // Default
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            state.shareId = docRef.id;
            await db.collection('users').doc(state.user.uid).collection('docs').doc(state.docId).update({ shareId: state.shareId });
            
            initPresence(state.shareId); // Start tracking
            els.infoBtn.classList.remove('hidden'); // Show history button
            window.openShareModal();
        }

        window.updateSharePermissions = async () => {
            const mode = els.shareSelect.value;
            await db.collection('shared_docs').doc(state.shareId).update({ access: mode });
            // If switched to 'edit', all guests become editors instantly via snapshot listener
        };

        function updateShareLinkUI() {
            const url = `${window.location.origin}${window.location.pathname}?shareId=${state.shareId}`;
            document.getElementById('share-link-input').value = url;
        }

        window.copyShareLink = () => {
            const copyText = document.getElementById("share-link-input");
            copyText.select();
            document.execCommand("copy");
            alert("Link Copied!");
        };

        function loadRequests() {
            els.requestsContainer.classList.remove('hidden');
            if(state.unsubRequests) state.unsubRequests();
            
            state.unsubRequests = db.collection('shared_docs').doc(state.shareId).collection('requests').orderBy('ts', 'desc').onSnapshot(snap => {
                els.requestsList.innerHTML = '';
                if(snap.empty) {
                     els.requestsList.innerHTML = '<div class="text-xs text-muted">No pending requests</div>';
                     els.requestBadge.classList.add('hidden');
                     return;
                }
                
                els.requestBadge.classList.remove('hidden'); // Red dot
                snap.forEach(doc => {
                    const r = doc.data();
                    const div = document.createElement('div');
                    div.className = "flex justify-between items-center bg-bg p-2 rounded text-xs";
                    div.innerHTML = `<span><b>${r.name}</b> wants edit access</span> 
                    <div class="flex gap-1">
                        <button onclick="grantAccess('${doc.id}')" class="text-green-600 hover:bg-green-100 px-2 py-1 rounded">Grant (Open Editor)</button>
                        <button onclick="deleteRequest('${doc.id}')" class="text-red-500">‚úï</button>
                    </div>`;
                    els.requestsList.appendChild(div);
                });
            });
        }

        window.grantAccess = async (reqId) => {
            // Requirement: "user clicks... owner can give access... anyone with link gets access"
            // So we switch global mode to Edit
            if(confirm("This will switch the document to Public Editor mode. Everyone with the link can edit.")) {
                els.shareSelect.value = 'edit';
                await updateSharePermissions();
                await deleteRequest(reqId);
            }
        };

        window.deleteRequest = async (id) => {
            await db.collection('shared_docs').doc(state.shareId).collection('requests').doc(id).delete();
        };

        // --- INFO / HISTORY ---
        window.openInfoModal = () => {
            els.infoModal.classList.remove('hidden');
            db.collection('shared_docs').doc(state.shareId).collection('history').orderBy('ts', 'desc').limit(20).get().then(snap => {
                els.historyList.innerHTML = '';
                snap.forEach(doc => {
                    const h = doc.data();
                    const time = h.ts ? new Date(h.ts.toDate()).toLocaleTimeString() : '';
                    const d = document.createElement('div');
                    d.className = "text-xs border-b border-border py-2 text-muted flex justify-between";
                    d.innerHTML = `<span>${h.msg}</span> <span>${time}</span>`;
                    els.historyList.appendChild(d);
                });
            });
        }

        // --- STANDARD APP FUNCTIONS (From your original code) ---
        window.createNewDoc = async () => {
            const ref = await db.collection('users').doc(state.user.uid).collection('docs').add({
                title: 'Untitled', content: '', updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            // Select it automatically via onSnapshot
        };

        window.openDoc = (data) => {
            state.docId = data.id;
            state.shareId = data.shareId || null;
            els.title.value = data.title;
            els.title.disabled = false;
            quill.setContents(data.content);
            quill.enable();
            els.editorWrapper.classList.remove('opacity-50', 'pointer-events-none');
            
            // Highlight active in sidebar
            document.querySelectorAll('#doc-list > div').forEach(e => e.classList.remove('bg-[#252525]', 'text-white'));
            const activeEl = document.getElementById(`doc-${data.id}`);
            if(activeEl) activeEl.classList.add('bg-[#252525]', 'text-white');

            if(state.shareId) {
                initPresence(state.shareId);
                els.infoBtn.classList.remove('hidden');
            } else {
                els.infoBtn.classList.add('hidden');
                els.cursorsLayer.innerHTML = '';
            }
        };
        
        function renderSidebar() {
            const list = document.getElementById('doc-list');
            list.innerHTML = '';
            state.docs.forEach(d => {
                const div = document.createElement('div');
                div.id = `doc-${d.id}`;
                div.className = "p-3 rounded mb-1 cursor-pointer hover:bg-[#252525] text-gray-400 text-sm truncate transition";
                div.textContent = d.title || 'Untitled';
                div.onclick = () => openDoc(d);
                list.appendChild(div);
            });
        }

        // --- AUTH FORMS ---
        document.getElementById('auth-form').onsubmit = (e) => { e.preventDefault(); auth.signInWithEmailAndPassword(document.getElementById('email').value, document.getElementById('password').value).catch(e => document.getElementById('auth-error').textContent = e.message); };
        document.getElementById('signup-btn').onclick = () => { auth.createUserWithEmailAndPassword(document.getElementById('email').value, document.getElementById('password').value).catch(e => document.getElementById('auth-error').textContent = e.message); };

        function focusEditor() { if(!els.title.disabled) quill.focus(); }
        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('sidebar-closed'); }
        els.title.oninput = () => { isLocalChange = true; triggerSave(); };
        function triggerSave() { if(state.saveTimer) clearTimeout(state.saveTimer); state.saveTimer = setTimeout(saveContent, 1000); }
    </script>
</body>
</html>
