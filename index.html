<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZenDocs | Secure Sync</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        zen: {
                            900: '#121212', // Deep background
                            800: '#1e1e1e', // Card background
                            700: '#2d2d2d', // Border
                            100: '#e0e0e0', // Text
                            accent: '#64ffda' // Subtle accent
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <style>
        /* Custom Zen Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #121212; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #444; }

        /* Editor Overrides for Dark Mode */
        .ql-toolbar { background: #1e1e1e; border-color: #2d2d2d !important; border-top-left-radius: 8px; border-top-right-radius: 8px; }
        .ql-container { background: #121212; border-color: #2d2d2d !important; border-bottom-left-radius: 8px; border-bottom-right-radius: 8px; color: #e0e0e0; font-size: 16px; min-height: 60vh; }
        .ql-stroke { stroke: #e0e0e0 !important; }
        .ql-fill { fill: #e0e0e0 !important; }
        .ql-picker { color: #e0e0e0 !important; }
        
        /* Utility */
        .loader { border: 3px solid #333; border-top: 3px solid #64ffda; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        body { background-color: #121212; color: #e0e0e0; }
        .hidden-transition { opacity: 0; pointer-events: none; position: absolute; }
    </style>
</head>
<body class="h-screen w-screen overflow-hidden flex flex-col font-sans antialiased">

    <div id="app" class="flex-1 flex flex-col relative">

        <div id="auth-screen" class="absolute inset-0 z-50 bg-zen-900 flex items-center justify-center p-4">
            <div class="w-full max-w-md bg-zen-800 p-8 rounded-xl border border-zen-700 shadow-2xl">
                <h1 class="text-3xl font-light mb-2 text-white tracking-tight">Zen<span class="text-zen-accent font-bold">Docs</span></h1>
                <p class="text-gray-400 mb-8 text-sm">Secure, Encrypted, Synced.</p>
                
                <form id="auth-form" class="space-y-4">
                    <div>
                        <label class="block text-xs font-medium text-gray-500 mb-1 uppercase tracking-wider">Email</label>
                        <input type="email" id="email" class="w-full bg-zen-900 border border-zen-700 rounded p-3 text-white focus:border-zen-accent focus:outline-none transition-colors" placeholder="you@example.com" required>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-500 mb-1 uppercase tracking-wider">Password</label>
                        <input type="password" id="password" class="w-full bg-zen-900 border border-zen-700 rounded p-3 text-white focus:border-zen-accent focus:outline-none transition-colors" placeholder="••••••••" required>
                    </div>
                    <div class="pt-2">
                        <button type="submit" id="login-btn" class="w-full bg-white text-black font-bold py-3 rounded hover:bg-gray-200 transition-colors">Login</button>
                    </div>
                    <div class="pt-2">
                        <button type="button" id="signup-btn" class="w-full bg-transparent border border-zen-700 text-white font-bold py-3 rounded hover:bg-zen-700 transition-colors">Create Account</button>
                    </div>
                    <p id="auth-error" class="text-red-400 text-xs text-center mt-4 hidden"></p>
                </form>
            </div>
        </div>

        <div id="dashboard-screen" class="hidden flex-1 flex h-full">
            
            <aside class="w-72 bg-zen-800 border-r border-zen-700 flex flex-col hidden md:flex">
                <div class="p-6 border-b border-zen-700 flex justify-between items-center">
                    <span class="font-bold text-lg tracking-tight">Library</span>
                    <button id="new-doc-btn" class="bg-zen-700 hover:bg-zen-600 p-2 rounded-full transition text-zen-accent">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                    </button>
                </div>
                <div id="doc-list" class="flex-1 overflow-y-auto p-2 space-y-1">
                    <div class="text-center text-gray-600 mt-10 text-sm">Loading docs...</div>
                </div>
                <div class="p-4 border-t border-zen-700">
                    <div class="flex items-center justify-between">
                        <span id="user-email" class="text-xs text-gray-500 truncate max-w-[150px]"></span>
                        <button id="logout-btn" class="text-xs text-red-400 hover:text-red-300">Sign Out</button>
                    </div>
                </div>
            </aside>

            <button id="mobile-menu-btn" class="md:hidden absolute top-4 left-4 z-20 bg-zen-800 p-2 rounded shadow text-gray-300">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
            </button>

            <main class="flex-1 flex flex-col h-full relative bg-zen-900">
                <div class="h-16 border-b border-zen-700 flex items-center justify-between px-6 md:px-10 bg-zen-900">
                    <div class="flex-1 mr-4">
                        <input type="text" id="doc-title" class="bg-transparent text-xl font-bold text-white focus:outline-none w-full placeholder-gray-600" placeholder="Untitled Document">
                    </div>
                    <div class="flex items-center gap-4">
                        <span id="save-status" class="text-xs text-gray-500 uppercase tracking-widest font-semibold">Synced</span>
                        <button id="delete-doc-btn" class="text-gray-600 hover:text-red-500 transition">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                        </button>
                    </div>
                </div>

                <div class="flex-1 overflow-hidden flex flex-col">
                    <div id="editor-container" class="flex-1 overflow-y-auto"></div>
                </div>
            </main>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

    <script>
        // --- CONFIGURATION START ---
        // TODO: Replace this object with YOUR actual Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyD-YOUR_API_KEY_HERE",
            authDomain: "your-project.firebaseapp.com",
            projectId: "your-project-id",
            storageBucket: "your-project.appspot.com",
            messagingSenderId: "123456789",
            appId: "1:123456:web:123456"
        };
        // --- CONFIGURATION END ---

        // Initialize Firebase
        try {
            firebase.initializeApp(firebaseConfig);
        } catch(e) {
            console.error("Firebase Config Error. Did you replace the config object?", e);
            alert("Error: Firebase not configured. Please edit index.html and add your config.");
        }

        const auth = firebase.auth();
        const db = firebase.firestore();
        
        // State
        let currentUser = null;
        let currentDocId = null;
        let unsubscribeDocListener = null;
        let saveTimeout = null;

        // UI References
        const authScreen = document.getElementById('auth-screen');
        const dashboardScreen = document.getElementById('dashboard-screen');
        const authForm = document.getElementById('auth-form');
        const emailInput = document.getElementById('email');
        const passInput = document.getElementById('password');
        const authError = document.getElementById('auth-error');
        const docList = document.getElementById('doc-list');
        const docTitleInput = document.getElementById('doc-title');
        const saveStatus = document.getElementById('save-status');
        const userEmailDisplay = document.getElementById('user-email');

        // Initialize Editor
        var quill = new Quill('#editor-container', {
            theme: 'snow',
            modules: {
                toolbar: [
                    [{ 'header': [1, 2, 3, false] }],
                    ['bold', 'italic', 'underline', 'strike'],
                    [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                    [{ 'color': [] }, { 'background': [] }],
                    ['link', 'image', 'clean'] 
                ]
            },
            placeholder: 'Start writing your masterpiece...'
        });

        // --- AUTHENTICATION LOGIC ---

        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                userEmailDisplay.textContent = user.email;
                authScreen.classList.add('hidden');
                dashboardScreen.classList.remove('hidden');
                loadDocuments();
            } else {
                currentUser = null;
                authScreen.classList.remove('hidden');
                dashboardScreen.classList.add('hidden');
                // Cleanup
                if(unsubscribeDocListener) unsubscribeDocListener();
                docList.innerHTML = '';
            }
        });

        // Login
        authForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const email = emailInput.value;
            const pass = passInput.value;
            
            auth.signInWithEmailAndPassword(email, pass)
                .catch(error => {
                    authError.textContent = error.message;
                    authError.classList.remove('hidden');
                });
        });

        // Signup
        document.getElementById('signup-btn').addEventListener('click', () => {
            const email = emailInput.value;
            const pass = passInput.value;
            
            if(pass.length < 6) {
                authError.textContent = "Password must be at least 6 characters";
                authError.classList.remove('hidden');
                return;
            }

            auth.createUserWithEmailAndPassword(email, pass)
                .catch(error => {
                    authError.textContent = error.message;
                    authError.classList.remove('hidden');
                });
        });

        // Logout
        document.getElementById('logout-btn').addEventListener('click', () => {
            auth.signOut();
        });

        // --- DATABASE LOGIC ---

        // Load Sidebar List
        function loadDocuments() {
            // Real-time listener for document list
            db.collection('users').doc(currentUser.uid).collection('docs')
                .orderBy('updatedAt', 'desc')
                .onSnapshot(snapshot => {
                    docList.innerHTML = '';
                    if (snapshot.empty) {
                        docList.innerHTML = '<div class="text-center text-gray-600 text-sm mt-4">No documents yet.<br>Create one!</div>';
                    }
                    
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        const div = document.createElement('div');
                        const isActive = doc.id === currentDocId;
                        div.className = `p-3 rounded cursor-pointer transition flex flex-col ${isActive ? 'bg-zen-700 border-l-2 border-zen-accent' : 'hover:bg-zen-700 border-l-2 border-transparent'}`;
                        div.innerHTML = `
                            <span class="font-medium text-sm text-gray-200 truncate">${data.title || 'Untitled'}</span>
                            <span class="text-xs text-gray-500">${new Date(data.updatedAt?.toDate()).toLocaleDateString()}</span>
                        `;
                        div.onclick = () => openDocument(doc.id, data);
                        docList.appendChild(div);
                    });
                });
        }

        // Open Document
        function openDocument(id, data) {
            currentDocId = id;
            docTitleInput.value = data.title || '';
            // Silent update of editor content
            quill.setContents(data.content); 
            
            // Highlight active in sidebar is handled by the snapshot listener automatically re-rendering
            // But we might want to manually toggle class immediately for responsiveness if needed
        }

        // Create New Document
        document.getElementById('new-doc-btn').addEventListener('click', async () => {
            const newDocRef = await db.collection('users').doc(currentUser.uid).collection('docs').add({
                title: 'Untitled Document',
                content: '',
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            // Open it immediately
            currentDocId = newDocRef.id;
            docTitleInput.value = 'Untitled Document';
            quill.setText(''); 
        });

        // Delete Document
        document.getElementById('delete-doc-btn').addEventListener('click', async () => {
            if(!currentDocId) return;
            if(confirm('Are you sure you want to delete this document?')) {
                await db.collection('users').doc(currentUser.uid).collection('docs').doc(currentDocId).delete();
                currentDocId = null;
                docTitleInput.value = '';
                quill.setText('');
            }
        });

        // --- AUTO SAVE LOGIC ---

        function saveDocument() {
            if (!currentUser || !currentDocId) return;
            
            saveStatus.textContent = "Saving...";
            
            const content = quill.getContents();
            const title = docTitleInput.value;

            db.collection('users').doc(currentUser.uid).collection('docs').doc(currentDocId).set({
                title: title,
                content: content,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            }, { merge: true }).then(() => {
                saveStatus.textContent = "Synced";
            }).catch((err) => {
                console.error("Save error", err);
                saveStatus.textContent = "Error Saving";
            });
        }

        // Debounce Save: Only save after user stops typing for 1 second
        quill.on('text-change', () => {
            if(saveTimeout) clearTimeout(saveTimeout);
            saveStatus.textContent = "Unsaved changes...";
            saveTimeout = setTimeout(saveDocument, 1000);
        });

        docTitleInput.addEventListener('input', () => {
            if(saveTimeout) clearTimeout(saveTimeout);
            saveStatus.textContent = "Unsaved changes...";
            saveTimeout = setTimeout(saveDocument, 1000);
        });

        // Mobile Menu Toggle
        const mobileMenuBtn = document.getElementById('mobile-menu-btn');
        const sidebar = document.querySelector('aside');
        mobileMenuBtn.addEventListener('click', () => {
            sidebar.classList.toggle('hidden');
            sidebar.classList.toggle('absolute');
            sidebar.classList.toggle('z-10');
            sidebar.classList.toggle('h-full');
        });

    </script>
</body>
</html>
